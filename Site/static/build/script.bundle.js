!function(n){function t(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return n[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var e={};t.m=n,t.c=e,t.d=function(n,e,o){t.o(n,e)||Object.defineProperty(n,e,{configurable:!1,enumerable:!0,get:o})},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},t.p="",t(t.s=0)}([function(n,t,e){function o(n){return document.getElementById(n)}function i(){ret={};for(var n in gn){ret[n]={};var t=gn[n];ret[n].color=t,ret[n].idleColor=bn[n],ret[n].idleColor===pn?(ret[n].idleDark="#"+tinycolor(ret[n].idleColor).darken(10).toHex(),ret[n].idleText="#888"):(ret[n].idleDark="#"+tinycolor(ret[n].idleColor).darken(8).toHex(),ret[n].idleText="#ccc"),ret[n].altColor="#"+tinycolor(gn[n]).brighten(10).toHex();var e=tinycolor(t).isDark();ret[n].isDark=e,ret[n].slightlyDark=t,ret[n].dark="#"+tinycolor(t).desaturate(20).darken(e?10:20).toHex(),ret[n].veryDark="#"+tinycolor(t).desaturate(20).darken(40).toHex(),ret[n].light="#"+tinycolor(t).brighten(40).toHex()}return ret}function r(n){return s(n)+xn.basePitch}function s(n){var t=n%In.y;return Math.floor(n/In.y)*mn+t}function c(){return Math.floor(vn.canvas.width/In.x)}function u(){return Math.floor(vn.canvas.height/In.y)}function a(n,t){return{x:n,y:t}}function f(n){return a(Math.floor(n.x/c()),Math.floor(n.y/u()))}function l(n){return En[n%En.length]}function d(n){return n.x*In.y+n.y}function h(n){return{xy:a(n.x*c(),n.y*u()),wh:a(c(),u())}}function v(n){return n.x*In.y+n.y}function w(n){var t,e=d(n),o=r(e),i=l(o),s=l(o+6),c=(ln[i].isDark,ln[i].slightlyDark,ln[i].dark),u=ln[i].altColor,a=(ln[i].veryDark,ln[i].light),f=ln[i].idleColor,v=ln[i].idleDark,w=ln[i].idleText;return t="#"+tinycolor(gn[s]).desaturate(10).toHex(),{xy:n,offset:e,noteDisplay:i,pitch:o,color:ln[i].color,textColor:t,border:!1,bounds:h(n),draw:function(){var n;this.border?(this.drawColor("black"),this.drawSmall(c,55),this.drawSmall(this.color,10),n=this.textColor):(this.drawColor("black"),this.drawSmall(v,55),this.drawSmall(f,10),n=w),fn.fillStyle=n;var t;t=In.x<2?10:5;var e=Math.floor(this.bounds.wh.x/t)+"px sans serif";fn.font=e,fn.fillText(Dn[this.noteDisplay],this.bounds.xy.x+.15*this.bounds.wh.x,this.bounds.xy.y+.85*this.bounds.wh.y,this.bounds.wh.x-this.bounds.wh.x/10)},drawAlt:function(){this.drawColor(a),this.drawSmall(u,20)},drawColor:function(n){fn.fillStyle=n,fn.fillRect(this.bounds.xy.x,this.bounds.xy.y,this.bounds.wh.x,this.bounds.wh.y)},drawSmall:function(n,t){fn.fillStyle=n;var e=this.bounds.wh.y/t;fn.fillRect(this.bounds.xy.x+e,this.bounds.xy.y+e,this.bounds.wh.x-2*e,this.bounds.wh.y-2*e)},down:function(n){k(o),n||this.drawAlt(),vn.downBoxes[this.offset]=1},up:function(){O(o),this.draw(),delete vn.downBoxes[this.offset]}}}function y(){var n=[];hn={};for(var t=0;t<In.x;t++)for(var e=0;e<In.y;e++){var o=w(a(t,e));n.push(o),hn[o.pitch]||(hn[o.pitch]=o)}return n}function x(n){return a(n.offsetX?n.offsetX:n.pageX,n.offsetY?n.offsetY:n.pageY)}function g(){MIDI=window.MIDI,MIDI.loader=new widgets.Loader,MIDI.loadPlugin({instrument:"acoustic_grand_piano",soundfontUrl:"/static/js/MIDI.js/soundfont/",callback:function(){MIDI.loader.stop(),canvas=o("canvas");var n=function(n){D([f(x(n))])},t=!1,e=function(e){t=!0,n(e)},r=function(n){t=!1,D([])},s=function(n){n.preventDefault();var t=[];tl=n;for(var e=0;e<n.touches.length;e++)t.push(f(x(n.touches.item(e))));D(t)};/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?(canvas.addEventListener("touchstart",s),canvas.addEventListener("touchmove",s),canvas.addEventListener("touchend",function(n){D([])})):(canvas.addEventListener("mousedown",e),canvas.addEventListener("mousemove",function(e){t&&n(e)}),canvas.addEventListener("mouseup",r),canvas.addEventListener("mouseout",r)),vn.canvas=canvas,ln=i(),window.addEventListener("resize",T),T(),b()}})}function p(){return o("startStop")}function b(){var n=p();n.onclick=function(){Sn||(Sn=!0,MIDI.noteOn(0,25,10,0),MIDI.noteOff(0,25,0)),n.innerText===Tn?B():(console.log("stopping"),N())}}function D(n){for(var t=[],e=0;e<n.length;e++){touch=n[e];var o=dn[v(touch)];o&&t.push(o)}S(t)}function E(){xn.downHandlers={}}function I(n){for(var t={},e=0;e<n.length;e++){var o=n[e];t[o.offset]=o}return t}function m(){return xn.playListen!=wn.LISTENING&&xn.playListen!=wn.BETWEEN}function S(n){var t=I(n);if(m())for(var e=0;e<n.length;e++){var o=n[e];if(!(o.offset in vn.downBoxes)){o.down();for(var i in xn.downHandlers)xn.downHandlers[i](o.offset)}}for(var r in vn.downBoxes)r in t||dn[r].up()}function T(){canvas.width=canvas.offsetWidth,canvas.height=canvas.offsetHeight,fn=canvas.getContext("2d"),fn.fillStyle="#888",fn.fillRect(0,0,canvas.width,canvas.height),L()}function L(){dn=y();for(var n=0;n<dn.length;n++)dn[n].draw()}function C(){un()}function A(n){on(n.lessonList,C)}function M(n){xn.basePitch=n.base,In.x=n.w,In.y=n.h,T()}function B(){xn.running=!0,startStop.innerText=Ln,un()}function N(){xn.playListen===wn.PLAYING&&An.stops++,startStop.innerText=Tn,cn(xn.lessonReqId),E(),W(yn),An.interrupt(),xn.running=!1,J(),vn.consecutiveEmpties=0,P(),L()}function k(n){MIDI.noteOn(0,n,127,0),vn.downPitches[n]=1}function O(n){MIDI.noteOff(0,n,0),delete vn.downPitches[n]}function P(){Object.keys(vn.downPitches).forEach(function(n){O(n)})}function G(n,t){t?(hn[n].border=!0,hn[n].down()):k(n)}function H(n,t){t?hn[n].up():O(n)}function _(n,t,e){if(t>=n.sequence.length)return void e();var o=n.sequence[t],i=t<n.hintPrefix;G(o,i),F(yn,function(){H(o,i),F(yn,function(){_(n,t+1,e)},n.restMillis)},n.noteDurationMillis)}function F(n,t,e){var o=function(){R(n),t()};result=setTimeout(o,e),xn.timeouts[n]=result}function R(n){delete xn.timeouts[n]}function W(n){clearTimeout(xn.timeouts[n]),delete xn.timeouts[n]}function j(n,t){for(var e=0,o=0;o<t.length;o++){if(e>=n.length)return!0;n[e]===t[o]&&e++}return n.length-e}function q(n,t,e){for(var o=0,i=0,r=0;r<t.length;r++)if(t[r]==n[0]){if(o++,remainder=j(n,t.slice(r,Math.min(t.length,r+e))),remainder<=0)return{success:!0,canSucceed:!0};if(o>2)return{success:!1,canSucceed:!1};i=r}return t.length-i>=e?{success:!1,canSucceed:!1}:{success:!1,canSucceed:!0}}function Y(n,t){var e=t.sequence.length+t.tolerance,o=q(t.sequence,n.notes,e),i=o.success,r=i?vn.DONE_WAIT_SUCCESS:vn.DONE_WAIT_FAIL,s={isDone:i,wait:r,success:i};return i?s:o.canSucceed?s:{isDone:!0,wait:vn.DONE_WAIT_FAIL,success:!1}}function U(){$("#instruction").text("LISTEN"),xn.playListen=wn.LISTENING}function X(){$("#instruction").text("PLAY IT BACK"),xn.playListen=wn.PLAYING}function K(){$("#instruction").text("CORRECT")}function z(){$("#instruction").text("INCORRECT")}function J(){$("#instruction").text(""),xn.playListen=wn.IDLE}function Q(){$("#instruction").text(""),xn.playListen=wn.BETWEEN}function V(){return(new Date).getTime()}function Z(n){var t=Bn++;return Mn[t]=1,function(){if(t in Mn)return delete Mn[t],n.apply(null,arguments);console.log("already did once: "+t)}}function nn(n,t){X(),Nn.start(n.waitTimeMillis);var e={};An.recordingStartTime=V(),e.notes=[],e.noteTimes=[];var o=Z(function(t,o){delete xn.downHandlers[Cn],Q(),Nn.clear(),e.passed=t.success,o||(An.recordingBuffer[n.lessonKey]=e),tn()});An.interrupt=function(){var t=An.stops<=2;o(Y(e,n),t)};var i=function(){var i=Y(e,n);if(o(i),i.success?K():z(),0===e.notes.length){if(++vn.consecutiveEmpties>1)return void N()}else vn.consecutiveEmpties=0;F(yn,t,i.wait)},s=function(t){e.notes.push(r(t)),e.noteTimes.push(V()-An.recordingStartTime),Y(e,n).isDone&&(W(yn),i())};xn.downHandlers[Cn]=s,F(yn,i,n.waitTimeMillis)}function tn(){$.isEmptyObject(An.recordingBuffer)||(an("/recording",An.recordingBuffer),An.recordingBuffer={})}function en(n,t){U(),M(n),F(yn,function(){_(n,0,function(){nn(n,t)})},500)}function on(n,t){rn(n,0,t)}function rn(n,t,e){if(t>=n.length)return void e();en(n[t],function(){rn(n,t+1,e)})}function sn(n,t,e){var o=On++;return kn[o]=1,$.get(n,t,function(n){o in kn?e(n):console.log("ignoring request "+o),delete kn[o]}),o}function cn(n){delete kn[n]}function un(){xn.running&&(xn.lessonReqId=sn("/lessons",{},A))}function an(n,t,e){$.post("/recording",{json:JSON.stringify(t)},e,"json")}var fn,ln,dn,hn,vn={downBoxes:{},downPitches:{},DONE_WAIT_SUCCESS:1e3,DONE_WAIT_FAIL:2e3,consecutiveEmpties:0},wn={PLAYING:0,LISTENING:1,IDLE:2,BETWEEN:3},yn=123,xn={timeouts:{},basePitch:36,running:!1,downHandlers:{},playListen:wn.PLAYING,lessonReqId:-1},gn={C:"#fd0100","C#":"#6537fc",D:"#ffff6b","D#":"#c900c8",E:"#d5ffeb",F:"#c50224","F#":"#6bb5fc",G:"#ffbd35","G#":"#be01fd",A:"#9fff9e","A#":"#97014b",B:"#9feeff"},pn="white",bn={C:pn,"C#":"#333",D:pn,"D#":"#333",E:pn,F:pn,"F#":"#333",G:pn,"G#":"#333",A:pn,"A#":"#333",B:pn},Dn={C:"C","C#":"C#/Db",D:"D","D#":"D#/Eb",E:"E",F:"F","F#":"F#/Gb",G:"G","G#":"G#/Ab",A:"A","A#":"A#/Bb",B:"B"},En=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],In={x:4,y:5},mn=5,Sn=!1,Tn="START",Ln="STOP",Cn="DOWN_HANDLER",An={recordingStartTime:-1,recordingBuffer:{},stops:0,interrupt:function(){}},Mn={},Bn=0,Nn={start:function(n){var t=V(),e=function(){$("#timer").text(Math.ceil((n-(V()-t))/1e3)),F(456,e,300)};e()},clear:function(){$("#timer").text(""),W(456)}},kn={},On=0;window.addEventListener("load",g)}]);