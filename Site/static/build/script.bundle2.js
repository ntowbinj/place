!function(n){function t(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return n[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var e={};t.m=n,t.c=e,t.d=function(n,e,o){t.o(n,e)||Object.defineProperty(n,e,{configurable:!1,enumerable:!0,get:o})},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},t.p="",t(t.s=0)}([function(n,t,e){function o(n){return document.getElementById(n)}function i(){ret={};for(var n in pn){ret[n]={};var t=pn[n];ret[n].color=t,ret[n].idleColor=Dn[n],ret[n].idleColor===bn?(ret[n].idleDark="#"+tinycolor(ret[n].idleColor).darken(10).toHex(),ret[n].idleText="#888"):(ret[n].idleDark="#"+tinycolor(ret[n].idleColor).darken(8).toHex(),ret[n].idleText="#ccc"),ret[n].altColor="#"+tinycolor(pn[n]).brighten(10).toHex();var e=tinycolor(t).isDark();ret[n].isDark=e,ret[n].slightlyDark=t,ret[n].dark="#"+tinycolor(t).desaturate(20).darken(e?10:20).toHex(),ret[n].veryDark="#"+tinycolor(t).desaturate(20).darken(40).toHex(),ret[n].light="#"+tinycolor(t).brighten(40).toHex()}return ret}function r(n){return s(n)+gn.basePitch}function s(n){var t=n%mn.y;return Math.floor(n/mn.y)*Sn+t}function c(){return Math.floor(wn.canvas.width/mn.x)}function u(){return Math.floor(wn.canvas.height/mn.y)}function a(n,t){return{x:n,y:t}}function f(n){return a(Math.floor(n.x/c()),Math.floor(n.y/u()))}function l(n){return In[n%In.length]}function d(n){return n.x*mn.y+n.y}function h(n){return{xy:a(n.x*c(),n.y*u()),wh:a(c(),u())}}function v(n){return n.x*mn.y+n.y}function w(n){var t,e=d(n),o=r(e),i=l(o),s=l(o+6),c=(dn[i].isDark,dn[i].slightlyDark,dn[i].dark),u=dn[i].altColor,a=(dn[i].veryDark,dn[i].light),f=dn[i].idleColor,v=dn[i].idleDark,w=dn[i].idleText;return t="#"+tinycolor(pn[s]).desaturate(10).toHex(),{xy:n,offset:e,noteDisplay:i,pitch:o,color:dn[i].color,textColor:t,border:!1,bounds:h(n),draw:function(){var n;this.border?(this.drawColor("black"),this.drawSmall(c,55),this.drawSmall(this.color,10),n=this.textColor):(this.drawColor("black"),this.drawSmall(v,55),this.drawSmall(f,10),n=w),ln.fillStyle=n;var t;t=mn.x<2?10:5;var e=Math.floor(this.bounds.wh.x/t)+"px sans serif";ln.font=e,ln.fillText(En[this.noteDisplay],this.bounds.xy.x+.15*this.bounds.wh.x,this.bounds.xy.y+.85*this.bounds.wh.y,this.bounds.wh.x-this.bounds.wh.x/10)},drawAlt:function(){this.drawColor(a),this.drawSmall(u,20)},drawColor:function(n){ln.fillStyle=n,ln.fillRect(this.bounds.xy.x,this.bounds.xy.y,this.bounds.wh.x,this.bounds.wh.y)},drawSmall:function(n,t){ln.fillStyle=n;var e=this.bounds.wh.y/t;ln.fillRect(this.bounds.xy.x+e,this.bounds.xy.y+e,this.bounds.wh.x-2*e,this.bounds.wh.y-2*e)},down:function(n){k(o),n||this.drawAlt(),wn.downBoxes[this.offset]=1},up:function(){O(o),this.draw(),delete wn.downBoxes[this.offset]}}}function x(){var n=[];vn={};for(var t=0;t<mn.x;t++)for(var e=0;e<mn.y;e++){var o=w(a(t,e));n.push(o),vn[o.pitch]||(vn[o.pitch]=o)}return n}function y(n){return a(n.offsetX?n.offsetX:n.pageX,n.offsetY?n.offsetY:n.pageY)}function g(){MIDI=window.MIDI,MIDI.loader=new widgets.Loader,MIDI.loadPlugin({instrument:"acoustic_grand_piano",soundfontUrl:"/static/js/MIDI.js/soundfont/",callback:function(){MIDI.loader.stop(),canvas=o("canvas");var n=function(n){D([f(y(n))])},t=!1,e=function(e){t=!0,n(e)},r=function(n){t=!1,D([])},s=function(n){n.preventDefault();var t=[];tl=n;for(var e=0;e<n.touches.length;e++)t.push(f(y(n.touches.item(e))));D(t)};/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?(canvas.addEventListener("touchstart",s),canvas.addEventListener("touchmove",s),canvas.addEventListener("touchend",function(n){D([])})):(canvas.addEventListener("mousedown",e),canvas.addEventListener("mousemove",function(e){t&&n(e)}),canvas.addEventListener("mouseup",r),canvas.addEventListener("mouseout",r)),wn.canvas=canvas,dn=i(),window.addEventListener("resize",T),T(),b()}})}function p(){return o("startStop")}function b(){var n=p();n.onclick=function(){Tn||(Tn=!0,MIDI.noteOn(0,25,10,0),MIDI.noteOff(0,25,0)),n.innerText===Ln?B():(console.log("stopping"),N())}}function D(n){for(var t=[],e=0;e<n.length;e++){touch=n[e];var o=hn[v(touch)];o&&t.push(o)}S(t)}function E(){gn.downHandlers={}}function I(n){for(var t={},e=0;e<n.length;e++){var o=n[e];t[o.offset]=o}return t}function m(){return gn.playListen!=xn.LISTENING&&gn.playListen!=xn.BETWEEN}function S(n){var t=I(n);if(m())for(var e=0;e<n.length;e++){var o=n[e];if(!(o.offset in wn.downBoxes)){o.down();for(var i in gn.downHandlers)gn.downHandlers[i](o.offset)}}for(var r in wn.downBoxes)r in t||hn[r].up()}function T(){canvas.width=canvas.offsetWidth,canvas.height=canvas.offsetHeight,ln=canvas.getContext("2d"),ln.fillStyle="#888",ln.fillRect(0,0,canvas.width,canvas.height),L()}function L(){hn=x();for(var n=0;n<hn.length;n++)hn[n].draw()}function C(){an()}function A(n){U(n.level),rn(n.lessonList,C)}function M(n){gn.basePitch=n.base,mn.x=n.w,mn.y=n.h,T()}function B(){gn.running=!0,startStop.innerText=Cn,an()}function N(){gn.playListen===xn.PLAYING&&Mn.stops++,startStop.innerText=Ln,un(gn.lessonReqId),E(),W(yn),Mn.interrupt(),gn.running=!1,Q(),wn.consecutiveEmpties=0,P(),L()}function k(n){MIDI.noteOn(0,n,127,0),wn.downPitches[n]=1}function O(n){MIDI.noteOff(0,n,0),delete wn.downPitches[n]}function P(){Object.keys(wn.downPitches).forEach(function(n){O(n)})}function G(n,t){t?(vn[n].border=!0,vn[n].down()):k(n)}function H(n,t){t?vn[n].up():O(n)}function _(n,t,e){if(t>=n.sequence.length)return void e();var o=n.sequence[t],i=t<n.hintPrefix;G(o,i),F(yn,function(){H(o,i),F(yn,function(){_(n,t+1,e)},n.restMillis)},n.noteDurationMillis)}function F(n,t,e){var o=function(){R(n),t()};result=setTimeout(o,e),gn.timeouts[n]=result}function R(n){delete gn.timeouts[n]}function W(n){clearTimeout(gn.timeouts[n]),delete gn.timeouts[n]}function j(n,t){for(var e=0,o=0;o<t.length;o++){if(e>=n.length)return!0;n[e]===t[o]&&e++}return n.length-e}function q(n,t,e){for(var o=0,i=0,r=0;r<t.length;r++)if(t[r]==n[0]){if(o++,remainder=j(n,t.slice(r,Math.min(t.length,r+e))),remainder<=0)return{success:!0,canSucceed:!0};if(o>2)return{success:!1,canSucceed:!1};i=r}return t.length-i>=e?{success:!1,canSucceed:!1}:{success:!1,canSucceed:!0}}function Y(n,t){var e=t.sequence.length+t.tolerance,o=q(t.sequence,n.notes,e),i=o.success,r=i?wn.DONE_WAIT_SUCCESS:wn.DONE_WAIT_FAIL,s={isDone:i,wait:r,success:i};return i?s:o.canSucceed?s:{isDone:!0,wait:wn.DONE_WAIT_FAIL,success:!1}}function U(n){var t=$("#level");console.log("level: "+n),t.text("level "+n)}function X(){$("#instruction").text("LISTEN"),gn.playListen=xn.LISTENING}function K(){$("#instruction").text("PLAY IT BACK"),gn.playListen=xn.PLAYING}function z(){$("#instruction").text("CORRECT")}function J(){$("#instruction").text("INCORRECT")}function Q(){$("#instruction").text(""),gn.playListen=xn.IDLE}function V(){$("#instruction").text(""),gn.playListen=xn.BETWEEN}function Z(){return(new Date).getTime()}function nn(n){var t=Nn++;return Bn[t]=1,function(){if(t in Bn)return delete Bn[t],n.apply(null,arguments);console.log("already did once: "+t)}}function tn(n,t){K(),kn.start(n.waitTimeMillis);var e={};Mn.recordingStartTime=Z(),e.notes=[],e.noteTimes=[];var o=nn(function(t,o){delete gn.downHandlers[An],V(),kn.clear(),e.passed=t.success,o||(Mn.recordingBuffer[n.lessonKey]=e),en()});Mn.interrupt=function(){var t=Mn.stops<=2;o(Y(e,n),t)};var i=function(){var i=Y(e,n);if(o(i),i.success?z():J(),0===e.notes.length){if(++wn.consecutiveEmpties>1)return void N()}else wn.consecutiveEmpties=0;F(yn,t,i.wait)},s=function(t){e.notes.push(r(t)),e.noteTimes.push(Z()-Mn.recordingStartTime),Y(e,n).isDone&&(W(yn),i())};gn.downHandlers[An]=s,F(yn,i,n.waitTimeMillis)}function en(){$.isEmptyObject(Mn.recordingBuffer)||(fn("/recording",Mn.recordingBuffer),Mn.recordingBuffer={})}function on(n,t){X(),M(n),F(yn,function(){_(n,0,function(){tn(n,t)})},500)}function rn(n,t){sn(n,0,t)}function sn(n,t,e){if(t>=n.length)return void e();on(n[t],function(){sn(n,t+1,e)})}function cn(n,t,e){var o=Pn++;return On[o]=1,$.get(n,t,function(n){o in On?e(n):console.log("ignoring request "+o),delete On[o]}),o}function un(n){delete On[n]}function an(){gn.running&&(gn.lessonReqId=cn("/lessons",{},A))}function fn(n,t,e){$.post("/recording",{json:JSON.stringify(t)},e,"json")}var ln,dn,hn,vn,wn={downBoxes:{},downPitches:{},DONE_WAIT_SUCCESS:1e3,DONE_WAIT_FAIL:2e3,consecutiveEmpties:0},xn={PLAYING:0,LISTENING:1,IDLE:2,BETWEEN:3},yn=123,gn={timeouts:{},basePitch:36,running:!1,downHandlers:{},playListen:xn.PLAYING,lessonReqId:-1},pn={C:"#fd0100","C#":"#6537fc",D:"#ffff6b","D#":"#c900c8",E:"#d5ffeb",F:"#c50224","F#":"#6bb5fc",G:"#ffbd35","G#":"#be01fd",A:"#9fff9e","A#":"#97014b",B:"#9feeff"},bn="white",Dn={C:bn,"C#":"#333",D:bn,"D#":"#333",E:bn,F:bn,"F#":"#333",G:bn,"G#":"#333",A:bn,"A#":"#333",B:bn},En={C:"C","C#":"C#/Db",D:"D","D#":"D#/Eb",E:"E",F:"F","F#":"F#/Gb",G:"G","G#":"G#/Ab",A:"A","A#":"A#/Bb",B:"B"},In=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],mn={x:4,y:5},Sn=5,Tn=!1,Ln="START",Cn="STOP",An="DOWN_HANDLER",Mn={recordingStartTime:-1,recordingBuffer:{},stops:0,interrupt:function(){}},Bn={},Nn=0,kn={start:function(n){var t=Z(),e=function(){$("#timer").text(Math.ceil((n-(Z()-t))/1e3)),F(456,e,300)};e()},clear:function(){$("#timer").text(""),W(456)}},On={},Pn=0;window.addEventListener("load",g)}]);